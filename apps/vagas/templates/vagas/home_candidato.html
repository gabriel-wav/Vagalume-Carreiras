{% extends 'base.html' %}
{% load static %}

{% block title %}Meu Dashboard{% endblock %}

{% block content %}

<style>
    main.main-container { display: block; padding: 20px 0; width: 100%; max-width: 100%; overflow-x: hidden; }
    
    .hero { text-align: center; padding: 40px 20px; min-height: 180px; display: flex; flex-direction: column; justify-content: center; transition: opacity 0.3s ease; }
    .hero.transitioning { opacity: 0; }
    .hero h1 { font-size: clamp(2rem, 5vw, 2.5rem); margin-bottom: 10px; transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1); color: #fff; }
    .hero h1 .username { color: #BEF264; }
    .hero p { color: #94a3b8; font-size: 1.1rem; transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1); }
    .popup-info { color: #BEF264; font-size: 1rem; margin-top: 10px; }
    
    .tabs { display: flex; justify-content: center; gap: 30px; margin-bottom: 40px; border-bottom: 1px solid #30363d; position: relative; max-width: 1200px; margin-left: auto; margin-right: auto; }
    .tab { background: none; border: none; color: #94a3b8; font-size: 1rem; padding: 15px 20px; cursor: pointer; position: relative; font-family: 'Plus Jakarta Sans', sans-serif; transition: color 0.3s ease; z-index: 1; }
    .tab:hover { color: #fff; }
    .tab.active { color: #fff; font-weight: 700; }
    .tab-indicator { position: absolute; bottom: -1px; height: 3px; background-color: #BEF264; transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1); z-index: 2; }
    
    .dashboard-window { width: 100%; position: relative; overflow: hidden; min-height: 600px; }
    .dashboard-slider { display: flex; width: 400%; transition: transform 0.6s cubic-bezier(0.4, 0, 0.2, 1); will-change: transform; }
    .panel { width: 25%; flex-shrink: 0; box-sizing: border-box; padding: 0 20px; opacity: 1; transition: opacity 0.3s ease; }
    .panel.inactive { opacity: 0.3; pointer-events: none; }
    .show-tab-0 { transform: translateX(0); }
    .show-tab-1 { transform: translateX(-25%); }
    .show-tab-2 { transform: translateX(-50%); }
    .show-tab-3 { transform: translateX(-75%); }
    
    .container { max-width: 1200px; margin: 0 auto; }
    .jobs-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 25px; }
    .job-card { background: #111111; border: 1px solid #1e293b; border-radius: 12px; padding: 25px; transition: transform 0.2s, border-color 0.3s; position: relative; background-image: url("{% static 'vagas/img/vagalume_icon.png' %}"); background-repeat: no-repeat; background-position: right -10px bottom -10px; background-size: 150px; }
    .job-card:hover { transform: translateY(-5px); border-color: #2d3f52; }
    .job-card::before { content: ''; position: absolute; top: 0; right: 0; width: 200px; height: 200px; background: radial-gradient(circle, rgba(190, 242, 100, 0.03) 0%, transparent 70%); pointer-events: none; }
    .job-card .tags { display: flex; gap: 8px; margin-bottom: 15px; flex-wrap: wrap; }
    .job-card .tag { padding: 4px 12px; background-color: rgba(255, 255, 255, 0.05); border: 1px solid #2d3f52; border-radius: 20px; font-size: 0.8rem; color: #94a3b8; }
    .job-title { color: #fff; margin-bottom: 5px; font-size: 1.3rem; font-weight: 600; }
    .company { color: #64748b; font-size: 0.95rem; margin-bottom: 20px; display: block; }
    .job-footer { display: flex; justify-content: space-between; align-items: center; margin-top: 15px; }
    .apply-btn { background: #AFEB83; color: #0D1B2A; border: none; padding: 10px 24px; border-radius: 6px; font-weight: 700; cursor: pointer; transition: all 0.3s; }
    .apply-btn:hover { background: #BEF264; transform: scale(1.05); }
    .candidates { display: flex; align-items: center; gap: 5px; color: #64748b; font-size: 0.9rem; }
    .candidates svg { width: 16px; height: 16px; }
    
    .perfil-container { max-width: 1100px; margin: 0 auto; display: grid; grid-template-columns: 1fr 1.5fr; gap: 30px; }
    .perfil-box { background: #111111; border: 1px solid #1e293b; border-radius: 12px; padding: 30px; height: fit-content; position: relative; }
    .perfil-box::before { content: ''; position: absolute; top: 0; right: 0; width: 200px; height: 200px; background: radial-gradient(circle, rgba(190, 242, 100, 0.03) 0%, transparent 70%); pointer-events: none; }
    .perfil-box h2 { color: #fff; margin-bottom: 25px; border-bottom: 1px solid #30363d; padding-bottom: 15px; font-size: 1.5rem; }
    .perfil-form label { display: block; color: #c9d1d9; font-weight: 600; margin-bottom: 8px; font-size: 0.95rem; }
    .perfil-form input, .perfil-form select { width: 100%; padding: 12px; background: #0D1B2A; border: 1px solid #30363d; color: #fff; border-radius: 6px; margin-bottom: 20px; font-family: inherit; transition: border-color 0.3s; }
    .perfil-form input:focus, .perfil-form select:focus { border-color: #BEF264; outline: none; }
    .btn-save { width: 100%; background: #BEF264; color: #0D1B2A; font-weight: 800; padding: 14px; border: none; border-radius: 6px; cursor: pointer; margin-top: 10px; font-size: 1rem; transition: background-color 0.3s; }
    .btn-save:hover { background-color: #a7e052; }
    .cv-section { margin-bottom: 30px; }
    .cv-section h3 { color: #BEF264; font-size: 1.1rem; margin-bottom: 12px; text-transform: uppercase; letter-spacing: 1px; font-weight: 700; }
    .cv-content { color: #c9d1d9; font-size: 1rem; line-height: 1.6; }
    .skill-tag { display: inline-block; background: #2d3f52; color: #fff; padding: 6px 14px; border-radius: 20px; font-size: 0.9rem; margin-right: 8px; margin-bottom: 8px; border: 1px solid #30363d; transition: all 0.3s; }
    .skill-tag:hover { border-color: #BEF264; color: #BEF264; }
    .xp-item, .edu-item { padding-left: 20px; border-left: 3px solid #30363d; margin-bottom: 20px; position: relative; }
    .xp-item::before, .edu-item::before { content: ''; width: 12px; height: 12px; background: #BEF264; border-radius: 50%; position: absolute; left: -7.5px; top: 0; }
    .xp-item strong, .edu-item strong { color: #fff; display: block; font-size: 1.1rem; margin-bottom: 4px; }
    .xp-item span, .edu-item span { color: #8b949e; font-size: 0.9rem; display: block; margin-bottom: 8px; }
    .xp-item p, .edu-item p { color: #c9d1d9; font-size: 0.95rem; }
    .empty-section { text-align: center; padding: 60px 20px; color: #8b949e; }
    .empty-section h2 { color: #fff; margin-bottom: 20px; font-size: 2rem; }
    .empty-section p { font-size: 1.2rem; }
    
    .onboarding-container { display: none; max-width: 600px; margin: 40px auto; padding: 40px; background: #1a2332; border-radius: 12px; text-align: center; border: 1px solid #30363d; box-shadow: 0 20px 50px rgba(0,0,0,0.5); }
    .onboarding-title { color: #fff; font-size: 2rem; margin-bottom: 10px; font-weight: 800; }
    .onboarding-subtitle { color: #8b949e; margin-bottom: 30px; font-size: 1.1rem; }
    .container-ativo { display: block; animation: fadeInUp 0.6s cubic-bezier(0.25, 1, 0.5, 1); }
    @keyframes fadeInUp { from { opacity: 0; transform: translateY(30px); } to { opacity: 1; transform: translateY(0); } }
    #progress-bar-fixed-wrapper { max-width: 600px; margin: 20px auto; }
    .progress-bar-wrapper { width: 100%; height: 8px; background: #0D1117; border-radius: 4px; overflow: hidden; }
    .progress-bar-fill { width: 0%; height: 100%; background: #AFEB83; transition: width 0.8s ease; }
    #progresso-texto { color: #BEF264; margin-bottom: 8px; text-align: right; font-weight: 700; font-size: 0.9rem; }
    .onboarding-form textarea { width: 100%; height: 120px; background: #0D1117; border: 1px solid #30363d; color: #fff; padding: 15px; border-radius: 8px; resize: none; font-family: inherit; margin-bottom: 20px; }
    .onboarding-form p { text-align: left; margin-bottom: 15px; }
    .onboarding-form label { display: block; color: #c9d1d9; margin-bottom: 5px; font-weight: 600; }
    .onboarding-form input, .onboarding-form select { width: 100%; padding: 12px; background: #0D1117; border: 1px solid #30363d; color: #fff; border-radius: 6px; }
    
    @media (max-width: 900px) {
        .perfil-container { grid-template-columns: 1fr; }
        .jobs-grid { grid-template-columns: 1fr; }
        .panel { padding: 0 10px; }
        .tabs { gap: 15px; }
        .tab { font-size: 0.9rem; padding: 12px 15px; }
    }
</style>

<div id="progress-bar-fixed-wrapper" style="display: none;">
    <p id="progresso-texto">0%</p>
    <div class="progress-bar-wrapper"><div class="progress-bar-fill" id="progresso-barra"></div></div>
</div>

<div id="onboarding-wrapper" style="display: none;">
    <div class="onboarding-container" id="onboarding-step-1">
        <h1 class="onboarding-title">Bem-vindo(a), {{ user.first_name|default:user.username }}!</h1>
        <p class="onboarding-subtitle">Vamos preparar seu perfil para que as melhores oportunidades encontrem você.</p>
        <button id="btn-iniciar-onboarding" class="btn-save" style="width: auto; padding: 12px 40px;">Vamos começar</button>
    </div>

    <div class="onboarding-container" id="onboarding-step-2">
        <h1 class="onboarding-title">Resumo Profissional</h1>
        <p class="onboarding-subtitle">Fale um pouco sobre seus objetivos e carreira.</p>
        <form id="form-step-2" action="{% url 'ajax_salvar_resumo' %}" method="POST" class="onboarding-form">
            {% csrf_token %}
            <textarea name="resumo" placeholder="Sou um desenvolvedor apaixonado por...">{{ texto_resumo }}</textarea>
            <div style="text-align: right;"><button type="submit" class="btn-save" style="width: auto;">Continuar</button></div>
        </form>
    </div>

    <div class="onboarding-container" id="onboarding-step-3">
        <h1 class="onboarding-title">Experiência</h1>
        <form id="form-step-3" action="{% url 'ajax_salvar_experiencia' %}" method="POST" class="onboarding-form">
            {% csrf_token %}{{ experiencia_form.as_p }}
            <div style="display: flex; justify-content: space-between; margin-top: 20px;">
                <button type="submit" name="salvar_outro" class="btn-save" style="background: transparent; border: 1px solid #30363d; color: #c9d1d9; width: auto;">+ Adicionar Outra</button>
                <button type="submit" name="continuar" class="btn-save" style="width: auto;">Continuar</button>
            </div>
        </form>
        <div id="lista-experiencias" style="text-align: left; margin-top: 20px;"></div>
    </div>

    <div class="onboarding-container" id="onboarding-step-4">
        <h1 class="onboarding-title">Formação</h1>
        <form id="form-step-4" action="{% url 'ajax_salvar_formacao' %}" method="POST" class="onboarding-form">
            {% csrf_token %}{{ formacao_form.as_p }}
            <div style="display: flex; justify-content: space-between; margin-top: 20px;">
                <button type="submit" name="salvar_outro" class="btn-save" style="background: transparent; border: 1px solid #30363d; color: #c9d1d9; width: auto;">+ Adicionar Outra</button>
                <button type="submit" name="continuar" class="btn-save" style="width: auto;">Continuar</button>
            </div>
        </form>
        <div id="lista-formacoes" style="text-align: left; margin-top: 20px;"></div>
    </div>

    <div class="onboarding-container" id="onboarding-step-5">
        <h1 class="onboarding-title">Habilidades</h1>
        <form id="form-step-5" action="{% url 'ajax_salvar_skill' %}" method="POST" class="onboarding-form">
            {% csrf_token %}{{ skill_form.as_p }}
            <div style="display: flex; justify-content: space-between; margin-top: 20px;">
                <button type="submit" name="salvar_outro" class="btn-save" style="background: transparent; border: 1px solid #30363d; color: #c9d1d9; width: auto;">+ Adicionar Outra</button>
                <button type="submit" name="continuar" class="btn-save" style="width: auto;">Continuar</button>
            </div>
        </form>
        <div id="lista-skills" style="text-align: left; margin-top: 20px;"></div>
    </div>

    <div class="onboarding-container" id="onboarding-step-6">
        <h1 class="onboarding-title">Currículo PDF</h1>
        <p class="onboarding-subtitle">Para completar, anexe seu CV (opcional).</p>
        <form id="form-step-6" action="{% url 'ajax_salvar_curriculo' %}" method="POST" enctype="multipart/form-data" class="onboarding-form">
            {% csrf_token %}{{ curriculo_form.as_p }}
            <div style="text-align: right; margin-top: 20px;"><button type="submit" class="btn-save" style="width: auto;">Finalizar Cadastro</button></div>
        </form>
    </div>
</div>

<div id="main-interface" class="dashboard-window">
    <section class="hero" id="dynamic-hero">
        <h1 id="hero-title">Olá, <span class="username">{{ user.first_name|default:user.username }}</span></h1>
        <p id="hero-subtitle">Confira as vagas recomendadas para você.</p>
        {% if messages %}{% for message in messages %}{% if 'FIRST_LOGIN' not in message.tags %}<div class="popup-info">{{ message }}</div>{% endif %}{% endfor %}{% endif %}
    </section>

    <div class="tabs" id="tabs-container">
        <button class="tab active" data-index="0">Recomendados</button>
        <button class="tab" data-index="1">Perfil</button>
        <button class="tab" data-index="2">Finança</button>
        <button class="tab" data-index="3">Configurações</button>
        <div class="tab-indicator" id="tab-indicator"></div>
    </div>

    <div class="dashboard-slider show-tab-0" id="slider">
        <div class="panel">
            <div class="container">
                <div class="jobs-grid">
                    {% for vaga in vagas %}
                    <div class="job-card">
                        <div class="tags"><span class="tag">{{ vaga.tipo_contrato }}</span><span class="tag">{{ vaga.localidade }}</span></div>
                        <h3 class="job-title">{{ vaga.titulo }}</h3>
                        <span class="company">{{ vaga.empresa.nome }}</span>
                        <div class="job-footer">
                            <div class="candidates"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path><circle cx="9" cy="7" r="4"></circle><path d="M23 21v-2a4 4 0 0 0-3-3.87"></path><path d="M16 3.13a4 4 0 0 1 0 7.75"></path></svg>+12</div>
                            <form action="{% url 'aplicar_vaga' vaga.id %}" method="POST" style="margin:0;">{% csrf_token %}<button class="apply-btn">Candidatar</button></form>
                        </div>
                    </div>
                    {% empty %}<p style="color:#8b949e; grid-column: 1/-1; text-align: center; padding: 40px;">Nenhuma vaga encontrada no momento.</p>{% endfor %}
                </div>
            </div>
        </div>

        <div class="panel inactive">
            <div class="perfil-container">
                <div class="perfil-box">
                    <h2>Editar Dados</h2>
                    <form method="POST" class="perfil-form">
                        {% csrf_token %}
                        {% if perfil_user_form %}{{ perfil_user_form.as_p }}{% else %}<label>Nome</label><input type="text" name="first_name" value="{{ user.first_name }}"><label>Sobrenome</label><input type="text" name="last_name" value="{{ user.last_name }}"><label>Telefone</label><input type="text" name="telefone" value="{{ user.telefone }}">{% endif %}
                        {% if perfil_candidato_form %}{{ perfil_candidato_form.as_p }}{% else %}<label>Headline</label><input type="text" name="headline" value="{{ user.candidato.headline }}">{% endif %}
                        <label>Gênero</label><select name="genero_fake"><option>Prefiro não informar</option><option>Masculino</option><option>Feminino</option><option>Outro</option></select>
                        <label>Bairro</label><input type="text" name="bairro_fake" placeholder="Seu bairro">
                        <label>LinkedIn</label><input type="text" name="linkedin_fake" placeholder="URL do LinkedIn">
                        <button type="submit" class="btn-save">Salvar Alterações</button>
                    </form>
                </div>

                <div class="perfil-box">
                    <h2>Visualização do Currículo</h2>
                    <div class="cv-section"><h3>Resumo Profissional</h3><p class="cv-content">{{ texto_resumo|default:"Nenhum resumo cadastrado." }}</p></div>
                    <div class="cv-section"><h3>Habilidades (Hard Skills)</h3>{% for skill in hard_skills %}<span class="skill-tag">{{ skill.nome }}</span>{% empty %}<span class="cv-content">Nenhuma registrada.</span>{% endfor %}</div>
                    <div class="cv-section"><h3>Habilidades (Soft Skills)</h3>{% for skill in soft_skills %}<span class="skill-tag">{{ skill.nome }}</span>{% empty %}<span class="cv-content">Nenhuma registrada.</span>{% endfor %}</div>
                    <div class="cv-section"><h3>Experiência Profissional</h3>{% for exp in experiencias %}<div class="xp-item"><strong>{{ exp.cargo }}</strong><span>{{ exp.empresa }} | {{ exp.data_inicio|date:"Y" }}</span>{% if exp.descricao %}<p>{{ exp.descricao }}</p>{% endif %}</div>{% empty %}<span class="cv-content">Nenhuma experiência registrada.</span>{% endfor %}</div>
                    <div class="cv-section"><h3>Formação Acadêmica</h3>{% for edu in formacoes %}<div class="edu-item"><strong>{{ edu.nome_formacao }}</strong><span>{{ edu.nome_instituicao }} ({{ edu.nivel }})</span></div>{% empty %}<span class="cv-content">Nenhuma formação registrada.</span>{% endfor %}</div>
                </div>
            </div>
        </div>

        <div class="panel inactive"><div class="empty-section"><h2>Área de Finanças</h2><p>Em breve: controle de pagamentos, histórico de transações e mais.</p></div></div>
        <div class="panel inactive"><div class="empty-section"><h2>Configurações</h2><p>Em breve: preferências de conta, privacidade e notificações.</p></div></div>
    </div>
</div>

<script>
const panelData=[{title:'Olá, <span class="username">{{ user.first_name|default:user.username }}</span>',subtitle:'Confira as vagas recomendadas para você.'},{title:'Meu Perfil',subtitle:'Gerencie seus dados e visualização do currículo.'},{title:'Finanças',subtitle:'Controle seus pagamentos e transações.'},{title:'Configurações',subtitle:'Ajuste suas preferências de conta.'}];
const slider=document.getElementById('slider'),tabs=document.querySelectorAll('.tab'),indicator=document.getElementById('tab-indicator'),hero=document.getElementById('dynamic-hero'),heroTitle=document.getElementById('hero-title'),heroSubtitle=document.getElementById('hero-subtitle'),panels=document.querySelectorAll('.panel');
let currentTab=0;
function updateIndicator(tab){const rect=tab.getBoundingClientRect(),containerRect=tab.parentElement.getBoundingClientRect();indicator.style.width=rect.width+'px';indicator.style.left=(rect.left-containerRect.left)+'px'}
function updateHero(index){hero.classList.add('transitioning');setTimeout(()=>{heroTitle.innerHTML=panelData[index].title;heroSubtitle.textContent=panelData[index].subtitle;hero.classList.remove('transitioning')},300)}
function goToTab(index){if(index===currentTab)return;tabs.forEach(tab=>tab.classList.remove('active'));tabs[index].classList.add('active');updateIndicator(tabs[index]);slider.className='dashboard-slider show-tab-'+index;panels.forEach((panel,i)=>{i===index?panel.classList.remove('inactive'):panel.classList.add('inactive')});updateHero(index);window.scrollTo({top:0,behavior:'smooth'});currentTab=index}
tabs.forEach((tab,index)=>{tab.addEventListener('click',()=>goToTab(index))});
window.addEventListener('load',()=>{updateIndicator(tabs[0])});
window.addEventListener('resize',()=>{updateIndicator(tabs[currentTab])});

const mainInterface=document.getElementById('main-interface'),onboardingWrapper=document.getElementById('onboarding-wrapper');
document.addEventListener('DOMContentLoaded',function(){
async function enviarFormulario(form,botaoPressionado){const url=form.action,formData=new FormData(form);if(botaoPressionado)formData.append(botaoPressionado.name,botaoPressionado.value);try{const response=await fetch(url,{method:'POST',body:formData,headers:{'X-CSRFToken':form.querySelector('[name=csrfmiddlewaretoken]').value}});const data=await response.json();if(data.status==='success'){if(data.action==='next_step')return true;const lista=document.getElementById(data.list_id);if(lista&&data.saved_item_html)lista.innerHTML+=data.saved_item_html;form.reset();return false}else{let msg='Erro no formulário.';if(data.errors)msg=JSON.stringify(data.errors);alert(msg);return false}}catch(e){console.error(e);alert('Erro de conexão.');return false}}
const steps=[document.getElementById('onboarding-step-1'),document.getElementById('onboarding-step-2'),document.getElementById('onboarding-step-3'),document.getElementById('onboarding-step-4'),document.getElementById('onboarding-step-5'),document.getElementById('onboarding-step-6')];
function showStep(index){steps.forEach((s,i)=>{s.style.display=i===index?'block':'none';if(i===index)s.classList.add('container-ativo')});const progress=document.getElementById('progresso-barra'),progressTxt=document.getElementById('progresso-texto'),pct=Math.round(((index+1)/steps.length)*100);if(progress)progress.style.width=pct+'%';if(progressTxt)progressTxt.innerText=pct+'%'}
let isFirstLogin=false;{% if messages %}{% for message in messages %}{% if 'FIRST_LOGIN' in message.tags %}isFirstLogin=true;{% endif %}{% endfor %}{% endif %}
if(isFirstLogin){mainInterface.style.display='none';document.getElementById('progress-bar-fixed-wrapper').style.display='block';onboardingWrapper.style.display='block';showStep(0);document.getElementById('btn-iniciar-onboarding').onclick=()=>showStep(1);document.getElementById('form-step-2').onsubmit=async(e)=>{e.preventDefault();if(await enviarFormulario(e.target,e.submitter))showStep(2)};document.getElementById('form-step-3').onsubmit=async(e)=>{e.preventDefault();if(e.submitter.name==='continuar'&&!e.target.querySelector('[name=cargo]').value){showStep(3);return}if(await enviarFormulario(e.target,e.submitter))showStep(3)};document.getElementById('form-step-4').onsubmit=async(e)=>{e.preventDefault();if(e.submitter.name==='continuar'&&!e.target.querySelector('[name=nome_formacao]').value){showStep(4);return}if(await enviarFormulario(e.target,e.submitter))showStep(4)};document.getElementById('form-step-5').onsubmit=async(e)=>{e.preventDefault();if(e.submitter.name==='continuar'&&!e.target.querySelector('[name=nome]').value){showStep(5);return}if(await enviarFormulario(e.target,e.submitter))showStep(5)};document.getElementById('form-step-6').onsubmit=async(e)=>{e.preventDefault();if(await enviarFormulario(e.target,e.submitter)){onboardingWrapper.style.display='none';document.getElementById('progress-bar-fixed-wrapper').style.display='none';mainInterface.style.display='block';updateIndicator(tabs[0])}}}else{onboardingWrapper.style.display='none';mainInterface.style.display='block'}});
</script>

{% endblock %}